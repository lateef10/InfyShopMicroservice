# Deploy to Azure Kubernetes Service
# Build and push image to Azure Container Registry; Deploy to Azure Kubernetes Service
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
    branches:
        include:
        - master
    paths:
        include:
        - AzureKubernetes/mssql.yml

resources:
- repo: self

variables:

  #Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '65baa412-40b1-4d0d-b59c-6db7e9b71530'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'containerimagebuild370945a4-auth'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'


stages:
- stage: Deploy
  displayName: Deploy MSSQL

  jobs:
  - deployment: Deploy
    displayName: Deploy
    pool:
      vmImage: $(vmImageName)
    environment: 'lateef10InfyShopMicroservice-2017.default'
    strategy:
      runOnce:
        deploy:
          steps:
          # - task: Kubernetes@1
          #   inputs:
          #     connectionType: 'Kubernetes Service Connection'
          #     kubernetesServiceEndpoint: 'infycluster-default-1216'
          #     namespace: 'default'
          #     command: 'apply'
          #     useConfigurationFile: true
          #     configuration: '$(Pipeline.Workspace)/mssql.yml'


          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)'
              Contents: 'AzureKubernetes/mssql.yml'
              TargetFolder: '$(build.artifactstagingdirectory)'
              
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'
              
          - task: Kubernetes@1
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: 'infycluster-default-1216'
              namespace: 'default'
              command: 'apply'
              arguments: '-f mssql.yml'
              workingDirectory: '$(build.artifactstagingdirectory)'


# variables:
#   # Container registry service connection established during pipeline creation
#   dockerRegistryServiceConnection: '6f6d5ef9-0523-4e1f-9d8c-dea06991a56a'
#   imageRepository: 'testinfyshopmicroservice'
#   containerRegistry: 'containerimagebuild.azurecr.io'
#   dockerfilePath: 'InfyShop.CouponAPI/Dockerfile'
#   tag: '$(Build.BuildId)'

#   # Agent VM image name
#   vmImageName: 'ubuntu-latest'

# stages:
# - stage: Build
#   displayName: Build and push stage
#   jobs:
#   - job: Build
#     displayName: Build
#     pool:
#       vmImage: $(vmImageName)
#     steps:
#     - task: Docker@2
#       displayName: Build and push an image to container registry
#       inputs:
#         command: buildAndPush
#         repository: $(imageRepository)
#         dockerfile: $(dockerfilePath)
#         containerRegistry: $(dockerRegistryServiceConnection)
#         buildContext: '$(Build.Repository.LocalPath)'
#         tags: |
#           $(tag)

#     - task: CopyFiles@2
#       inputs:
#         SourceFolder: 'AzureKubernetes'
#         Contents: 'mssql.yml'
#         TargetFolder: '$(build.artifactstagingdirectory)'

#     - task: PublishBuildArtifacts@1
#       inputs:
#         PathtoPublish: '$(Build.ArtifactStagingDirectory)'
#         ArtifactName: 'drop'
#         publishLocation: 'Container'